var b=0;const S=$(".message-form"),E=$(".message-input"),a=$(".wsus__chat_area_body"),d=$("meta[name=csrf_token]").attr("content"),B=$("meta[name=auth_id]").attr("content"),i=$(".messenger-contacts"),r=()=>$("meta[name=id]").attr("content"),A=s=>$("meta[name=id]").attr("content",s);function O(){$(".wsus__message_paceholder").removeClass("d-none")}function M(){$(".wsus__chat_app").removeClass("show_info"),$(".wsus__message_paceholder").addClass("d-none"),$(".wsus__message_paceholder_black").addClass("d-none")}function w(s,e){if(s.files&&s.files[0]){var t=new FileReader;t.onload=function(n){$(e).attr("src",n.target.result)},t.readAsDataURL(s.files[0])}}let c=1,u=!1,k="",f=!1;function y(s){s!=k&&(c=1,u=!1),k=s,!f&&!u&&$.ajax({method:"GET",url:"/messenger/search",data:{query:s,page:c},beforeSend:function(){f=!0,$(".user_search_list_result").append(`
                <div class="text-center search-loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                `)},success:function(e){f=!1,$(".user_search_list_result").find(".search-loader").remove(),c<2?$(".user_search_list_result").html(e.records):$(".user_search_list_result").append(e.records),u=c>=(e==null?void 0:e.last_page),u||(c+=1)},error:function(e,t,n){f=!1,$(".user_search_list_result").find(".search-loader").remove()}})}function p(s,e,t=!1){$(s).on("scroll",function(){let n=$(this).get(0);(t?n.scrollTop==0:n.scrollTop+n.clientHeight>=n.scrollHeight)&&e()})}function G(s,e){let t;return function(...n){clearTimeout(t),t=setTimeout(()=>{s.apply(this,n)},e)}}function F(s){$.ajax({method:"GET",url:"/messenger/id-info",data:{id:s},beforeSend:function(){NProgress.start(),O()},success:function(e){j(e.fetch.id,!0),$(".wsus__chat_info_gallery").html(""),e!=null&&e.shared_photos?($(".nothing_share").addClass("d-none"),$(".wsus__chat_info_gallery").html(e.shared_photos)):$(".nothing_share").removeClass("d-none"),e.favourite==1?$(".favourite").addClass("active"):$(".favourite").removeClass("active"),$(".messenger_header").find("img").attr("src",e.fetch.avatar),$(".messenger_header").find("h4").text(e.fetch.name),$(".messenger_info_view .user_photo").find("img").attr("src",e.fetch.avatar),$(".messenger_info_view").find(".user_name").text(e.fetch.name),$(".messenger_info_view").find(".user_unique_name").text(e.fetch.username),NProgress.done()},error:function(e,t,n){M()}})}function R(){b+=1;let s=`temp_${b}`,e=!!$(".attachment-input").val();const t=E.val();if(t.length>0||e){const n=new FormData($(".message-form")[0]);n.append("id",r()),n.append("tempMsgId",s),n.append("_token",d),$.ajax({method:"POST",url:"/messenger/send-message",data:n,dataType:"JSON",processData:!1,contentType:!1,beforeSend:function(){e?a.append(C(t,s,!0)):a.append(C(t,s)),L(a),H()},success:function(o){D(r());const _=a.find(`.message-card[data-id="${o.tempID}"]`);_.before(o.message),_.remove(),P()},error:function(o,_,Y){}})}}function C(s,e,t=!1){return t?`
        <div class="wsus__single_chat_area message-card" data-id="${e}">
            <div class="wsus__single_chat chat_right">
                <div class="pre_loader">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                ${s.length>0?`<p class="messages">${s}</p>`:""}
                <span class="clock"><i class="fas fa-clock"></i> now</span>
                
            </div>
        </div>
        `:`
        <div class="wsus__single_chat_area message-card" data-id="${e}">
            <div class="wsus__single_chat chat_right">
                <p class="messages">${s}</p>
                <span class="clock"><i class="fas fa-clock"></i> now</span>

            </div>
        </div>
        `}function H(){$(".attachment-block").addClass("d-none"),S.trigger("reset"),$(".emojionearea").text("")}function N(){$(".attachment-block").addClass("d-none")}let l=1,m=!1,v=!1;function j(s,e=!1){e&&(l=1,m=!1),!m&&!v&&$.ajax({method:"GET",url:"/messenger/fetch-messages",data:{_token:d,id:s,page:l},beforeSend:function(){v=!0,a.prepend(`
                <div class="text-center messages-loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                `)},success:function(t){if(v=!1,a.find(".messages-loader").remove(),q(),l==1)a.html(t.messages),L(a);else{const n=$(a).find(".message-card").first(),o=n.offset().top-a.scrollTop();a.prepend(t.messages),a.scrollTop(n.offset().top-o)}m=l>=(t==null?void 0:t.last_page),m||(l+=1),M()},error:function(t,n,o){console.log(o)}})}let h=1,x=!1,g=!1;function T(){!g&&!x&&$.ajax({method:"GET",url:"/messenger/fetch-contacts",data:{page:h},beforeSend:function(){g=!0,i.append(`
                <div class="text-center contact-loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                `)},success:function(s){g=!1,i.find(".contact-loader").remove(),h<2?i.html(s.contacts):i.append(s.contacts),x=h>=(s==null?void 0:s.last_page),x||(h+=1)},error:function(s,e,t){g=!1,i.find(".contact-loader").remove()}})}function D(s){s!=B&&$.ajax({method:"GET",url:"/messenger/update-contact-item",data:{username:s},success:function(e){i.find(`.messenger-list-item[data-id="${s}"]`).remove(),i.prepend(e.contact_item),s==r()&&I(s)},error:function(e,t,n){}})}function I(s){$("body").find(".messenger-list-item").removeClass("active"),$("body").find(`.messenger-list-item[data-id="${s}"]`).addClass("active")}function q(s){$(`.messenger-list-item[data-id="${r()}"]`).find(".unseen-count").remove(),$.ajax({method:"POST",url:"/messenger/make-seen",data:{_token:d,id:r()},success:function(e){},error:function(e,t,n){}})}function U(s){$(".favourite").toggleClass("active"),$.ajax({method:"POST",url:"/messenger/favourite",data:{_token:d,id:s},success:function(e){e.status=="added"?notyf.success("Added to favourite list."):notyf.success("Removed to favourite list.")},error:function(e,t,n){}})}function V(s){Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!"}).then(e=>{e.isConfirmed&&$.ajax({method:"DELETE",url:"/messenger/delete-message",data:{_token:d,message_id:s},beforeSend:function(){$(`.message-card[data-id="${s}"]`).remove(),console.log(s)},success:function(t){D(r())},error:function(t,n,o){}})})}function L(s){$(s).stop().animate({scrollTop:$(s)[0].scrollHeight})}function P(){$("#example1").emojioneArea({pickerPosition:"top",tonesStyle:"radio",events:{keyup:function(s,e){$("#example1").val(this.getText()).trigger("keyup")}}})}$(document).ready(function(){T(),P(),window.innerWidth<768&&($("body").on("click",".messenger-list-item",function(){$(".wsus__user_list").addClass("d-none")}),$("body").on("click",".back_to_list",function(){$(".wsus__user_list").removeClass("d-none")})),$("#select_file").change(function(){w(this,".profile-image-preview")});const s=G(function(){const e=$(".user_search").val();y(e)},500);$(".user_search").on("keyup",function(){$(this).val().length>0&&s()}),p(".user_search_list_result",function(){let e=$(".user_search").val();y(e)}),$("body").on("click",".messenger-list-item",function(){const e=$(this).attr("data-id");I(e),A(e),F(e)}),S.on("submit",function(e){e.preventDefault(),R()}),$(".attachment-input").change(function(){w(this,".attachment-preview"),$(".attachment-block").removeClass("d-none")}),$(".cancel-attachment").on("click",function(){N()}),p(".wsus__chat_area_body",function(){j(r())},!0),p(".messenger-contacts",function(){T()}),$(".favourite").on("click",function(e){e.preventDefault(),U(r())}),$("body").on("click",".dlt-message",function(e){e.preventDefault();let t=$(this).data("id");V(t)})});
